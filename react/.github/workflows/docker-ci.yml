name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Build the Docker image
      id: build
      continue-on-error: true
      run: |
        DOCKER_BUILDKIT=0 docker build \
          --add-host=npm.worldskills.uk:192.168.100.100 \
          --add-host=git.worldskills.uk:192.168.100.100 \
          . --file Dockerfile --tag git.worldskills.uk/${{ github.repository }}

    - name: Build error page on failure
      if: steps.build.outcome == 'failure'
      run: |
        mkdir -p /tmp/error-page
        cd /tmp/error-page
        echo 'FROM nginx:alpine' > Dockerfile
        echo 'RUN echo "<html><body><h1>Build Failed</h1><p>Check Gitea Actions for details.</p></body></html>" > /usr/share/nginx/html/index.html' >> Dockerfile
        DOCKER_BUILDKIT=0 docker build . --tag git.worldskills.uk/${{ github.repository }}

    - name: docker login
      env:
        USER: ${{ secrets.USER }}
        PASS: ${{ secrets.PASS }}
      run: docker login -u $USER -p $PASS git.worldskills.uk

    - name: push to docker hub
      run: docker push git.worldskills.uk/${{ github.repository }}

    - name: Fail job if build failed
      if: steps.build.outcome == 'failure'
      run: exit 1
